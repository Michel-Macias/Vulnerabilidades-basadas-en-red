# Práctica de Laboratorio: Enumeración de SMB con Enum4linux

Esta es una guía adaptada de la práctica de Cisco para ser usada en un entorno de laboratorio personal como Virt-Manager con una red NAT.

**Objetivo:** Enumerar usuarios y recursos compartidos de una máquina Windows desde Kali Linux usando `nmap`, `enum4linux` y `smbclient`.

**Máquinas Requeridas:**
*   Una VM con Kali Linux (atacante).
*   Una VM con Windows 8.1 (víctima) en la misma red NAT.

---

## Parte 1: Preparación y Descubrimiento

### Paso 1: Preparar el entorno en Kali Linux

La mayoría de los comandos requieren privilegios de root. Inicia una sesión de terminal en Kali y escala a root para no tener que escribir `sudo` constantemente.

```bash
# Conviértete en el usuario root
sudo su
```

### Paso 2: Descubrir la IP de la máquina Windows

Primero, necesitas saber el rango de tu red `NAT_lab` en Virt-Manager. Normalmente es algo como `192.168.122.0/24`. Una vez que lo sepas, usa `nmap` para escanear ese rango y encontrar hosts con los puertos de SMB abiertos.

> **Nota:** Reemplaza `[RANGO_DE_TU_RED_NAT_LAB]` con el rango de tu red. Por ejemplo: `192.168.122.0/24`.

```bash
# Escaneo de tipo "NULL scan" (-sN) para encontrar hosts y sus puertos abiertos
nmap -sN [RANGO_DE_TU_RED_NAT_LAB]
```

Busca en la salida de `nmap` un host que tenga los puertos **139/tcp** y **445/tcp** abiertos. Esa será la dirección IP de tu máquina Windows 8.1. **Apunta esa IP.**

Para el resto de esta guía, reemplaza `[IP_DE_TU_WINDOWS_8.1]` con la dirección que has encontrado.

---

## Parte 2: Enumeración Profunda con Enum4linux

`enum4linux` es una herramienta que automatiza la extracción de información de sistemas Windows y Samba. Depende de herramientas del cliente de Samba (`rpcclient`, `net`, `nmblookup`, `smbclient`).

### Paso 1: Ver la ayuda y opciones

Es útil familiarizarse con las capacidades de la herramienta.

```bash
enum4linux --help
```

### Paso 2: Realizar una enumeración completa

La opción `-a` de `enum4linux` es muy potente, ya que ejecuta un conjunto completo de comprobaciones de enumeración de forma automática. Es un excelente punto de partida.

```bash
# Ejecuta una enumeración completa sobre tu máquina Windows
enum4linux -a [IP_DE_TU_WINDOWS_8.1]
```

Este comando intentará obtener:
*   **Lista de usuarios** (`-U`)
*   **Recursos compartidos** (`-S`)
*   **Lista de grupos** (`-G`)
*   **Política de contraseñas** (`-P`)
*   **Información del SO** (`-o`)
*   Y más...

Analiza la salida de este comando. Te proporcionará nombres de usuario, nombres de grupos, recursos compartidos (carpetas) a los que podrías intentar acceder, y la política de contraseñas (longitud mínima, historial, etc.), que es oro puro si planeas un ataque de fuerza bruta.

### Paso 3: Enumeración específica (Opcional)

Si solo te interesa una pieza de información, puedes usar las opciones individuales:

```bash
# Enumerar solo los usuarios
enum4linux -U [IP_DE_TU_WINDOWS_8.1]

# Enumerar solo los recursos compartidos
enum4linux -S [IP_DE_TU_WINDOWS_8.1]

# Obtener la política de contraseñas
enum4linux -P [IP_DE_TU_WINDOWS_8.1]
```

---

## Parte 3: Interactuar con SMB usando smbclient

Una vez que `enum4linux` ha descubierto recursos compartidos, puedes usar `smbclient` para intentar conectarte a ellos.

### Paso 1: Listar recursos compartidos con smbclient

Este comando te pedirá una contraseña. Si el recurso compartido no requiere autenticación, simplemente presiona `Enter`.

```bash
# Lista los recursos compartidos en el objetivo
smbclient -L //[IP_DE_TU_WINDOWS_8.1]/

# Cuando pida contraseña, presiona Enter
Password for [WORKGROUP\root]: [Enter]
```

### Paso 2: Conectarse a un recurso compartido

Supongamos que has encontrado un recurso compartido interesante y con permisos de escritura, por ejemplo, llamado `TEMP` o `Public`.

> **Nota:** Reemplaza `[NOMBRE_DEL_RECURSO]` por el nombre del recurso al que quieres conectarte.

```bash
# Conéctate al recurso compartido
smbclient //[IP_DE_TU_WINDOWS_8.1]/[NOMBRE_DEL_RECURSO]

# De nuevo, presiona Enter en la contraseña si no tienes una.
Password for [WORKGROUP\root]: [Enter]
```

Si la conexión es exitosa, tu prompt cambiará a `smb: \>`. Ahora estás dentro del recurso compartido.

### Paso 3: Transferir un archivo (Simulando la subida de malware)

Dentro del prompt `smb: \>`, puedes usar comandos similares a los de un cliente FTP.

1.  **Crea un archivo de prueba en tu máquina Kali** (en otra terminal, o antes de conectarte).
    ```bash
    echo "Este es un archivo de prueba" > prueba.txt
    ```

2.  **Dentro de `smbclient`, sube el archivo** con el comando `put`.
    ```smb
smb: \> help  # Muestra los comandos disponibles
smb: \> ls    # Lista los archivos en el recurso remoto
smb: \> put prueba.txt # Sube tu archivo local al recurso compartido
smb: \> ls    # Verifica que el archivo se ha subido
smb: \> quit  # Sal de smbclient
    ```

¡Felicidades! Has completado el ciclo de enumeración y explotación básica de SMB. Has encontrado un objetivo, enumerado su información sensible y has logrado escribir un archivo en uno de sus recursos compartidos.